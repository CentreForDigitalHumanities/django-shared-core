<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>cdh.files.db.wrappers &mdash; Django Shared Core 3.1.0 documentation</title>
            <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css"/>
            <link rel="stylesheet" href="../../../../_static/theme.css" type="text/css"/>
        <script src="../../../../_static/bootstrap.bundle.min.js"></script>
            
                    <script src="../../../../_static/documentation_options.js?v=dd1205ac"></script>
                    <script src="../../../../_static/doctools.js?v=888ff710"></script>
                    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
            <script src="../../../../_static/js/theme.js"></script>
            <link rel="index" title="Index" href="../../../../genindex.html"/>
            <link rel="search" title="Search" href="../../../../search.html"/> 
    <style>
        .navbar .caption {
            display: none;
        }
    </style>
</head>

<body>

<div class="uu-root-container">
    <div class="uu-header">
        <div class="uu-header-row">
            <div class="uu-logo">
                <img src="../../../../_static/logo-header-en.svg">
            </div>
            <div class="fs-3 ms-5 text-black">
                Django Shared Core 3.1.0 documentation
            </div>
            <div class="border-left ms-auto">
                <div role="search" class="ms-auto">
                  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
                    <input type="text" class="form-control" name="q" placeholder="Search docs" />
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                  </form>
                </div>
            </div>
        </div>
    </div>
        <nav class="navbar uu-navbar">
            <div class="uu-navbar-container">
                <a href="https://www.uu.nl" class="navbar-brand">
                    <img src="../../../../_static/logo-header-en.svg">
                </a>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbar-content"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon" />
                </button>
                <div id="navbar-content" class="collapse navbar-collapse">
                        <p class="caption" role="heading"><span class="caption-text">Index</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../migrating/index.html">Migrating</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/index.html">cdh</a></li>
</ul>

                </div>
            </div>
        </nav>
    <div class="uu-content">
        <div class="uu-hero"><ol class="breadcrumb mb-0">
    <li class="breadcrumb-item">
        <a href="../../../../index.html">
            Django Shared Core
        </a>
    </li>
    <li class="breadcrumb-item">
        <a href="../../../index.html"
           
               accesskey="U"
               class="active"
           >
           Module code
        </a>
    </li>
    <li class="breadcrumb-item active">cdh.files.db.wrappers</li>
</ol></div> 
                <div class="uu-container">
                    <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                            <div itemprop="articleBody">
                                
  <h1>Source code for cdh.files.db.wrappers</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">from</span> <span class="nn">django.core.files</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">import</span> <span class="nn">magic</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse_lazy</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">..mime_names</span> <span class="kn">import</span> <span class="n">get_name_from_mime</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">get_storage</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">TrackedFileField</span>
    <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">BaseFile</span>


<div class="viewcode-block" id="FileWrapper">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.FileWrapper">[docs]</a>
<span class="k">class</span> <span class="nc">FileWrapper</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">10</span>

<div class="viewcode-block" id="FileWrapper.__init__">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.FileWrapper.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_instance</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">original_filename</span><span class="p">):</span>
        <span class="c1"># self.file = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_filename</span> <span class="o">=</span> <span class="n">original_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span> <span class="o">=</span> <span class="n">file_instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">get_storage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_committed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removed</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># Sometimes the ORM expects a different field than id/pk; this function</span>
        <span class="c1"># checks if the requested attribute is said field, return id.</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">id</span>

        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such attribute &#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">filename_generator</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">filename_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_filename</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name_on_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No file instance. Can not retrieve filename &quot;</span>
                               <span class="s2">&quot;without it! (Please assign this object to a &quot;</span>
                               <span class="s2">&quot;FileField field of a model before saving)&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">_child_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">_child_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Alias these to the file_instance, as sometimes the ORM expects these</span>
    <span class="c1"># values</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">pk</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># For easier access</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
    <span class="n">created_by</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">created_by</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">created_on</span><span class="p">)</span>
    <span class="n">modified_on</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">modified_on</span><span class="p">)</span>

<div class="viewcode-block" id="FileWrapper.get_content_type_display">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.FileWrapper.get_content_type_display">[docs]</a>
    <span class="k">def</span> <span class="nf">get_content_type_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_name_from_mime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span> <span class="s1">&#39;Unknown file type&#39;</span><span class="p">)</span></div>


    <span class="c1"># The standard File contains most of the necessary properties, but</span>
    <span class="c1"># FieldFiles can be instantiated without a name, so that needs to</span>
    <span class="c1"># be checked for here.</span>

    <span class="k">def</span> <span class="nf">_require_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; attribute has no file associated with it.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span>

    <span class="k">def</span> <span class="nf">_set_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="c1"># You might think, why? Well, due to a very complicated descriptor chain</span>
        <span class="c1"># this might actually fail to set, in which case we really should stop</span>
        <span class="c1"># NOW #speakingFromExperience</span>
        <span class="c1"># It will only fail after a code change, so assert should be fine</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">==</span> <span class="n">file</span>

    <span class="k">def</span> <span class="nf">_del_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span>

    <span class="n">file</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_file</span><span class="p">,</span> <span class="n">_set_file</span><span class="p">,</span> <span class="n">_del_file</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_file</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">url_pattern</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_committed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">)</span>

<div class="viewcode-block" id="FileWrapper.open">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.FileWrapper.open">[docs]</a>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="c1"># open() doesn&#39;t alter the file&#39;s contents, but it does reset the pointer</span>
    <span class="nb">open</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># In addition to the standard File API, FieldFiles have extra methods</span>
    <span class="c1"># to further manipulate the underlying file, as well as update the</span>
    <span class="c1"># associated model instance.</span>

<div class="viewcode-block" id="FileWrapper.save">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.FileWrapper.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">original_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>

        <span class="k">if</span> <span class="n">original_filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">original_filename</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># If we overwrite the file this instance represents, we need to first</span>
        <span class="c1"># delete the old one, as otherwise we would lose the new file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">,</span>
            <span class="n">content</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">max_length</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_committed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Use magic to determine the mime type. It&#39;s pretty obvious, I know</span>
        <span class="c1"># I just liked saying &#39;use MAGIC&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2048</span><span class="p">),</span> <span class="n">mime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">mime</span>

        <span class="k">if</span> <span class="n">original_filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">original_filename</span> <span class="o">=</span> <span class="n">original_filename</span>

        <span class="c1"># TRACK_CREATED_BY should only be enabled if the right middleware is</span>
        <span class="c1"># loaded, so we don&#39;t check it. (A system check enforces it,</span>
        <span class="c1"># so we can actually be sure in this case)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">TRACK_CREATED_BY</span><span class="p">:</span> <span class="c1"># NoQA; We are allowed to access this linter</span>
            <span class="kn">from</span> <span class="nn">cdh.core.middleware</span> <span class="kn">import</span> <span class="n">get_current_user</span>
            <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>
            <span class="c1"># Make sure we don&#39;t try to safe using AnonymousUser</span>
            <span class="k">if</span> <span class="n">current_user</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


    <span class="n">save</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="FileWrapper.delete">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.FileWrapper.delete">[docs]</a>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes the file on disk. If save = True, the metadata object will</span>
<span class="sd">        also be deleted. Note: only delete the metadata object if no other DB</span>
<span class="sd">        object is referencing it, otherwise you&#39;ll get nasty Integrity</span>
<span class="sd">        errors!</span>

<span class="sd">        :param save: Whether to also delete the metadata in the DB, defaults</span>
<span class="sd">                     to True</span>
<span class="sd">        :param force: Whether to force a deletion if multiple DB objects still</span>
<span class="sd">                      refer to it, defaults to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># By default, only delete if there are no references in the DB anymore</span>
        <span class="n">deletion_threshold</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># If we are instructed to also destroy our file_instance and we still</span>
        <span class="c1"># have a reference, we allow deletion with 1 more reference</span>
        <span class="k">if</span> <span class="n">save</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">deletion_threshold</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Check if we only have the allowed amount number of references or fewer</span>
        <span class="c1"># If we have more, and we&#39;re not forcing a deletion, stop right here!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">_num_child_instances</span> <span class="o">&gt;</span> <span class="n">deletion_threshold</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># First, delete our metadata model. The check above _should_ make sure</span>
        <span class="c1"># we don&#39;t get integrity errors, but it&#39;s better to have this fail</span>
        <span class="c1"># because of those errors before we have actually deleted the file</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># Only close the file if it&#39;s already open, which we know by the</span>
        <span class="c1"># presence of self._file</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_file&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_on_disk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">original_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_committed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="o">.</span><span class="n">clear_file_wrappers</span><span class="p">()</span></div>


    <span class="n">delete</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">closed</span>

<div class="viewcode-block" id="FileWrapper.close">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.FileWrapper.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># FieldFile needs access to its associated model field, an instance and</span>
        <span class="c1"># the file&#39;s name. Everything else will be restored later, by</span>
        <span class="c1"># FileDescriptor below.</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;original_filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_filename</span><span class="p">,</span>
            <span class="s1">&#39;closed&#39;</span><span class="p">:</span>            <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;_committed&#39;</span><span class="p">:</span>        <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;_removed&#39;</span><span class="p">:</span>          <span class="bp">self</span><span class="o">.</span><span class="n">_removed</span><span class="p">,</span>
            <span class="s1">&#39;_file&#39;</span><span class="p">:</span>             <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;file_instance&#39;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">file_instance</span><span class="p">,</span>
            <span class="s1">&#39;field&#39;</span><span class="p">:</span>             <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">get_storage</span><span class="p">()</span></div>



<div class="viewcode-block" id="PrivateCacheMixin">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.PrivateCacheMixin">[docs]</a>
<span class="k">class</span> <span class="nc">PrivateCacheMixin</span><span class="p">:</span>

<div class="viewcode-block" id="PrivateCacheMixin.__init__">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.PrivateCacheMixin.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="PrivateCacheMixin.is_cached">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.PrivateCacheMixin.is_cached">[docs]</a>
    <span class="k">def</span> <span class="nf">is_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PrivateCacheMixin.get_cached_value">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.PrivateCacheMixin.get_cached_value">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cached_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PrivateCacheMixin.cache_value">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.PrivateCacheMixin.cache_value">[docs]</a>
    <span class="k">def</span> <span class="nf">cache_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="PrivateCacheMixin.invalidate_cache_value">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.PrivateCacheMixin.invalidate_cache_value">[docs]</a>
    <span class="k">def</span> <span class="nf">invalidate_cache_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PrivateCacheMixin.invalidate_caches">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.PrivateCacheMixin.invalidate_caches">[docs]</a>
    <span class="k">def</span> <span class="nf">invalidate_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span></div>
</div>



<div class="viewcode-block" id="TrackedFileWrapper">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.TrackedFileWrapper">[docs]</a>
<span class="k">class</span> <span class="nc">TrackedFileWrapper</span><span class="p">(</span><span class="n">PrivateCacheMixin</span><span class="p">):</span>

<div class="viewcode-block" id="TrackedFileWrapper.__init__">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.TrackedFileWrapper.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="s1">&#39;TrackedFileField&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span>
        <span class="c1"># This should retrieve the FileField actually holding the File; it&#39;s</span>
        <span class="c1"># a bit tricky to get it, as it&#39;s filename can differ if using custom</span>
        <span class="c1"># File model.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">()</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> &quot;</span> \
               <span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.&quot;</span> \
               <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span> \
               <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">attname</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_linking_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FileWrapper</span><span class="p">,</span> <span class="n">File</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a FileWrapper or File, this method will try to find the</span>
<span class="sd">        object linking it to an object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_linking_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">file_instance</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file_field</span><span class="o">.</span><span class="n">attname</span><span class="p">:</span> <span class="n">obj</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has_linking_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FileWrapper</span><span class="p">,</span> <span class="n">File</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a FileWrapper or File, this method will try to find the</span>
<span class="sd">        object linking it to an object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">file_instance</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file_field</span><span class="o">.</span><span class="n">attname</span><span class="p">:</span> <span class="n">obj</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_resolve_to_file_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">,</span> <span class="s1">&#39;BaseFile&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FileWrapper</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tries to map the input to a FileWrapper in this M2M;</span>
<span class="sd">        accepts a FileWrapper itself, a File instance and an int/uuid for a</span>
<span class="sd">        File instance&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">related_model</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_file_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_field</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_to_file_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_to_file_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">uuid</span><span class="o">=</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_to_file_wrapper</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_current_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FileWrapper</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tries to retrieve the file representing the &#39;current&#39; value of</span>
<span class="sd">        this field.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">linking_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">current</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">linking_instance</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">linking_instance</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_value</span><span class="p">(</span>
                <span class="s1">&#39;current&#39;</span><span class="p">,</span>
                <span class="n">value</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_set_current_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">,</span> <span class="s1">&#39;BaseFile&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tries to set a new file representing the &#39;current&#39; value of</span>
<span class="sd">        this field. It can be a file that&#39;s already tracked, or a new one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_current_file</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">resolved_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_to_file_wrapper</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># If we don&#39;t retrieved a value, just use .add;</span>
        <span class="c1"># Even if we get a value, the fact that we got a FileWrapper doesn&#39;t</span>
        <span class="c1"># mean it&#39;s _our_ FileWrapper. We could of course check FW._field or</span>
        <span class="c1"># FW.file_instance._child_fields; however, it&#39;s way easier to just do</span>
        <span class="c1"># an .exists check on the linking table. (As that&#39;s cheaper in terms</span>
        <span class="c1"># of computation and DB access).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved_value</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_linking_instance</span><span class="p">(</span><span class="n">resolved_value</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">resolved_value</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_as_current</span><span class="p">(</span><span class="n">resolved_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_del_current_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes the file currently represeting the &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>
        <span class="n">current_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_file</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">current_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">current_file</span><span class="p">)</span>

    <span class="n">current_file</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_current_file</span><span class="p">,</span>
        <span class="n">_set_current_file</span><span class="p">,</span>
        <span class="n">_del_current_file</span>
    <span class="p">)</span>
    <span class="n">current_file</span><span class="o">.</span><span class="n">fset</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">current_file</span><span class="o">.</span><span class="n">fdel</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_set_as_current</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_wrapper</span><span class="p">:</span> <span class="n">FileWrapper</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linking_instance</span><span class="p">(</span><span class="n">file_wrapper</span><span class="p">)</span>
        <span class="n">link</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">link</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache_value</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="n">file_wrapper</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">file</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_to_file_wrapper</span><span class="p">(</span><span class="n">file</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_on&#39;</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="TrackedFileWrapper.add">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.TrackedFileWrapper.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">,</span> <span class="s1">&#39;BaseFile&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">through_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="p">()</span>
        <span class="nb">setattr</span><span class="p">(</span>
            <span class="n">through_obj</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">m2m_field_name</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span>
        <span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span>
            <span class="n">through_obj</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">(),</span>
            <span class="n">file</span>
        <span class="p">)</span>
        <span class="n">file_wrapper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">through_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">())</span>
        <span class="n">file_wrapper</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">through_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_as_current</span><span class="p">(</span><span class="n">file_wrapper</span><span class="p">)</span></div>

    <span class="n">add</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="TrackedFileWrapper.set_as_current">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.TrackedFileWrapper.set_as_current">[docs]</a>
    <span class="k">def</span> <span class="nf">set_as_current</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">,</span> <span class="s1">&#39;BaseFile&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set None as current! (Did you mean to &quot;</span>
                             <span class="s2">&quot;delete stuff?)&quot;</span><span class="p">)</span>

        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_to_file_wrapper</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_as_current</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>

    <span class="n">set_as_current</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="TrackedFileWrapper.delete">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.TrackedFileWrapper.delete">[docs]</a>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">FileWrapper</span><span class="p">,</span> <span class="s1">&#39;BaseFile&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot delete None!&quot;</span><span class="p">)</span>

        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_to_file_wrapper</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linking_instance</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">link</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">current</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span></div>

    <span class="n">delete</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="TrackedFileWrapper.delete_all">
<a class="viewcode-back" href="../../../../reference/cdh.files.db.wrappers.html#cdh.files.db.wrappers.TrackedFileWrapper.delete_all">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete all files currently tracked&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span></div>

    <span class="n">delete_all</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span></div>

</pre></div>

                            </div>
                            </div>
                </div>
    </div>

    <footer class="uu-footer">

  <div role="contentinfo">
    <p>&#169; Copyright DH-IT Portal development.</p>
  </div> 

</footer>
</div>

</body>
</html>